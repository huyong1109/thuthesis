\chapter{国内外相关工作}
\label{cha:related}
本章主要介绍本文的正压求解器、迭代算法预处理技术和气候模式正确性验证这三个工作目前的研究现状。第\ref{solver:Backgroud}节介绍了海洋模式正压模态的求解方法及其优化，第\ref{related:precond}节介绍了求解线性方程组的迭代算法中主要的预处理技术，第\ref{related:verify}节介绍当前气候模式中已有的正确性验证方法。


\section{海洋模式正压求解技术}
\label{solver:Backgroud} 

过去的二十多年中，用来解决科学问题的超级计算机变得越来越强大。 
很多高性能计算领域的研究都在关注如何使得科学应用能够更加适应大规模的并行环境\cite{hu2013scalable}。 
没有可扩展的应用，超级计算机的功能再强大也不能对很多像海洋模拟这样科学领域十分重要的问题起到促进作用。 
利用超级计算机的并行环境进行数值气候模式的模拟，能够提高我们模拟和理解海洋运动过程、监视和预报大气海洋等状态的能力。
目前的气候模式为了能够更加准确的模拟大气、海洋和海冰等运动过程， 都趋向于采用更细粒度的水平和垂直分辨率，导致气候模式的规模也变得越来越大。 
随着气候模式分辨率的提高， 利用气候模式来做模拟的计算需求也会变得越来越巨大，这也使得在大规模并行环境中对海洋模式进行优化变得极其重要。 



目前有很多研究工作都是在关注气候系统模式的性能，尤其高分辨率气候模式在大规模并行环境中的可扩展性。 
气候模式，尤其是地球系统模式，由于包含有很多分量模式，结构复杂，代码量巨大，导致气候模式的性能并不乐观。 
本文主要以目前使用最为广泛的美国国家大气研究中心主要研发的公共地球系统模式（CESM）为研究对象。
在很多真实模拟中，海洋模式POP都是CESM中计算开销最大的一个分量\cite{Worley:2011:PCE:2063384.2063457, dennis2012computational}。 
因此，本文中，我们专注于提高海洋模式POP的性能优化。 
POP是一个十分有影响力的海洋模式，它是由美国Los Alamos国家实验室研发，多家研究机构共同发展。
海洋模式POP被广泛的应用于涡分辨率的海洋模拟\cite{mcclean2002eulerian, stark2004towards}，以及海洋和海冰或者大气和海洋相耦合的耦合模拟  \cite{May2002preliminary}。 
POP目前被著名的CESM采纳为其海洋模式分量。  
海洋模式POP采用经过静力平衡近似和Boussinesq近似的三维原始方程。 
为了避免快波（如重力波等）对时间步长的苛刻要求，它将时间积分分成两个部分： 一个是求解三维动力学和热动力学过程的斜压模态，另一个则是求解二维的垂直积分后的动量方程和连续性方程得到的二维海表高度（SSH）变化的正压模态\cite{smith2010parallel}。

已有的很多研究都明确的指出，海洋模式POP中，斜压模态的计算量占整个模式的绝大部分，但通信相对较少、可扩展性较好，其计算时间随着计算规模的增大而减少。
但是正压模态主要由边界更新和全局归约操作等通信开销组成，其计算时间开销占总计算时间开销的比例从几百核上的10\%增大到10,000多核上的50\%\cite{pop05,stone2011cgpop,Worley:2011:PCE:2063384.2063457, dennis2012computational}。
因此，海洋模式POP的性能主要受到正压模态中通信瓶颈的影响，提高海洋模式正压模态的可扩展性将有助于提高整个公共地球系统模式的性能。

在时间差分方案上，目前海洋模式中求解器正压模态既有显式方法，又有隐式方法\cite{griffies2000developments}。 
显式方法的优点是求解简单，容易并行，缺点是为了使得数值格式稳定需要很小的时间步长，导致模式整体的计算开销很大。
与之相反，隐式方法的求解复杂，但是计算效率更高。 
隐式计算正压模态，通常需要求解一个自由海表面的椭圆方程。在数值离散之后，这个椭圆方程可以转化成为一个稀疏的线性方程组。

 
求解器线性方程组的方法可以简单的分为直接法和迭代法。
直接法通常利用因式分解将系数矩阵转化成容易求逆的矩阵，它被广泛的应用于在很多将准确性作为首要条件的工业应用程序中，比如结构分析、半导体器件建模等不涉及到偏微分方程的领域\cite{benzi2002preconditioning}。
直接法通常比较健壮，并且需要的计算时间和存储资源都是可预估的。
但是，直接法的可扩展很差，尤其是对于高维度的偏微分方程离散后得到的线性方程组或者规模巨大线性方程组。 

迭代算法包括的内容比较广泛，如传统的Jacobi迭代，Gauss–Seidel迭代， SOR 迭代和 Krylov 子空间等方法\cite{saad2003iterative,barrett1994templates}。
当前的应用中，有很多需要求解含有几百万甚至更多的未知数的线性方程组。 对于这样的超大规模的问题，迭代算法是唯一的选择。
很多实际应用中，只需要一定精度的解，这时迭代算法需要的存储和计算量通常比直接法的少。 
迭代算法在核电工业，石油工业和气候模拟等领域应用十分广泛。

迭代算法中，Krylov 子空间方法，尤其是共轭梯度法（CG）及其相应的变种，由于效率很高，
被广泛的应用于海洋模式中正压模态的求解。
比较著名的海洋模式如MITgcm\citep{adcroft2014mitgcm}， FVCOM\citep{lai2010nonhydrostatic}， MOM3\citep{pacanowsky1999mom3}， OPA \citep{madec1997ocean}
都采用了共轭梯度法或其变种来隐式求解正压模态的方程。
然而，正如下一节（第\ref{related:bottleneck})我们将要介绍的，共轭梯度法在当前的海洋模式分量POP中造成了比较严重的通信瓶颈\citep{Worley:2011:PCE:2063384.2063457}。 

 

\subsection{正压模态通信瓶颈}
\label{related:bottleneck}

隐式自由面方法在求解海洋模式正压模态中是一个很常见的选择，因为它能够允许较大的时间步长来高效的计算速度很快（约200m/s)的重力波。
但是隐式自由面的求解需要隐式的求解一个椭圆方程，这正是正压模态的可扩展性较差主要原因。 
海洋模式正压模态中的椭圆方程通常会被近似为一个线性系统$Ax=b$。 
国际上很多流行的海洋模式都采用共轭梯度法及其变种求解海洋模式正压模态中的线性系统\citep{adcroft2014mitgcm,lai2010nonhydrostatic,madec1997ocean}。
但是，共轭梯度法自身有一个不适合大规模并行的缺陷，那就是每一步迭代过程中都涉及到两次求內积操作。 
当采用成百上千个处理器核心时， 做內积所需要的全局通信和同步操作就会是一个主要的瓶颈。

正压模态的执行时间占整个海洋模式POP的很大一部分，尤其是当它所使用大量的处理器核心时。
目前有很多研究工作都是在关注海洋模式POP的性能，尤其是它的正压模态的比较差的可扩展性。 
Jones\cite{pop05}等人在向量架构和常规集群的并行环境中测试了海洋模式POP1.4.3版本的可移植性，并且发现POP中斜压模态主要是由计算组成， 但是正压模态主要由边界更新和全局归约操作等通信开销组成。
Stone  \cite{stone2011cgpop}等人发现，正压模态的时间开销占总计算时间开销的比例从几百核上的10\%增大到10,000多核上的50\%。 
他们甚至还为此而开发了一个POP的简化版本，称之为CGPOP，专门用来研究海洋模式POP中的正压模态的新算法、数据结构和编程模型等。 
Worley  \cite{Worley:2011:PCE:2063384.2063457} 和 \cite{dennis2012computational} 等人在近30,000 核上测试了公共地球系统模式CESM的海洋模式分量POP 2.0.1的性能。 
他们发现，海洋模式POP在很多真实模拟中都是CESM中计算开销最大的一个分量，并且证明了在大规模并行时，海洋模式POP的性能主要受到正压模态中通信瓶颈的影响。 

\subsection{正压求解器的优化}
\label{related:improve}


正压求解器是高分辨率CESM版本中POP的主要性能瓶颈，因为当在大核数上运行时它的运行时间占了POP总运行时间的一大半。 
这是由于求解自由海表面的正压求解器中算法所固有的明显的全局通信操作在大核数下的可扩展性比较差所导致的。
目前已经有很多的关于如何优化正压模态性能的工作，其中大部分都是通过减少进程间的通信量或者加速每个进程上的计算速度来实现的。 

全局归约操作的开销和所使用的进程数的多少成正相关， 所以通信开销随着进程数的增加会逐渐变得不可接受。
很多研究工作都尝试去提高共轭梯度法的并行性能，减少其负面影响。 
比如在算法层面减少共轭梯度法的全局通信\cite{dAzevedo1999lapack}，在正压模态中实现计算与通信相重叠\cite{beare1997optimisation}，在海洋模式中移除陆地点并且实现负载均衡\cite{dennis2007inverse, dennis2008scaling}，以及使用异构加速平台对海洋模式正压模态进行加速等。

我们这里简单的从以下三个方面介绍一下相关工作。
首先，海洋模式正压模态中所使用的共轭梯度法在很多科学领域都有应用，
减少共轭梯度法的全局通信的开销在这个算法被并行化之后就一直是研究的热点。 
尽管计算机浮点运算速度不断提高，但是网络延迟的改进却很有限，导致计算和通信效率之间的差距越来越大。
负载不均衡、硬件的差异和操作系统的抖动都会对全局通信造成很大影响\cite{ghysels2014}。 
现在有很多的可选方案来缓解大规模并行环境中的预处理的共轭梯度法所固有的比较差的可扩展性。
一类是在算法层面对共轭梯度法进行改进。 
这个领域最早的成果是在标准的共轭梯度法的基础上做算法的修正从而减少全局归约操作的次数， 比如在海洋模式POP中被采用的Chronopoulos-Gear (ChronGear \cite{dAzevedo1999lapack})方法 。 这些方法至今仍然被广泛的使用着。 
早期还有s-步方法\cite{chron1989} 和最近的一些变种（比如Mark的工作\cite{hoemmen2010}）也能够减少全局通信， 但是这些方法很难结合复杂的预处理方法使用。
另外一类研究是通过将共轭梯度法中的全局通信与矩阵向量乘法利用流水线的方式来重叠，进而提高共轭梯度法的并行效率。关于如何减少共轭梯度法中全局通信的开销，文章\inlinecite{ghysels2014}给出了一个非常详尽的总结。
 



其次，针对海洋模式，有很多工作都是关于如何减少正压求解器中通信瓶颈所带来的影响。
正压模态的执行时间占整个海洋模式POP的很大一部分，尤其是当它所使用大量的处理器核心时。
海洋模式正压模态中的线性方程组是对海表高度的椭圆方程进行离散化之后得到的，是条带状的系数矩阵。
同时海洋模式的并行中，通常采用二维平面的划分，因此海洋模式中使用的共轭梯度法有着特殊的并行性质。
目前已经有很多的关于如何优化正压模态性能的工作，其中大部分都是减少所使用的进程数或者减少进程间的通信量。 
正压模态中，共轭梯度法每一步迭代所需要的全局归约操作的开销和所使用的进程数的多少成正相关的， 所以通信开销随着进程数的增加会逐渐变得不可接受。
OpenMP并行和陆地点移除在海洋模式中是比较常见的减少进程数量及其相应的通信开销的常用策略。  
在论文\inlinecite{Worley:2011:PCE:2063384.2063457}中， 他们在正压模态中采用OpenMP并行技术，解决斜压模态需要很多的处理器核心来进行计算而正压模态的进程数太多会造成通信瓶颈越大这一矛盾，进而提高了海洋模式在大核数上的性能。 
另一个比较常见的减少通信开销的策略是陆地点的移除\cite{dennis2007inverse,dennis2008scaling}。 
Dennis等人提出通过去掉全是陆地点的块来减少需要参与通信的处理器核心的数目，从而减少通信的开销。陆地点扣除之后，海洋水平网格将会变得不规则，他们继而提出了基于最新的空间填充曲线划分算法的负载均衡的策略来改善负载均衡。 
他们的实验表明，在接近30,000个处理器核心上，新的策略使得模式的模拟速度增加了近一倍。 
另外，减少通信的频率同样可以减轻正压模态中的性能瓶颈。 
早在1997年，  Beare\cite{beare1997optimisation}等人就提出来，通过增大边界通信缓存区域的块的大小以及将通信和计算相重叠减少通信开销，进而提高并行大洋环流模式的性能。  
尽管这些方法都能够对性能有一定的提升，但是他们并没有完全的消除掉全局归约操作的瓶颈。 

 

海洋模式中共轭梯度法的数据局部性比较差，而且很多操作只能串行执行，导致以上的改进方案的效果都十分有限。
最近异构计算技术的发展也在一定程度上使得正压模态的性能有所提升。 
已有一些工作利用异构加速平台，比如说GPUs \cite{cuomo2012pcg} 和FPGAs \cite{Shida2007}来实现对预处理共轭梯度法的加速。 
Cuomo 等人\cite{cuomo2012pcg}在全球环流海洋数值模式中引入了稀疏近似逆预处方法，并且利用一个科学计算库将其实现在GPU上。 
Shida 等人\cite{Shida2007}将海洋模式中的正压模态移植到FPGAs上，并且发现发现当适当的使用块上内存和流式的直接内存访问，一块100MHz的FPGA卡的性能能与1GHz的CPU处理器相当。 
GPUs和FPGAs还能够减少正压模态中的全局通信开销。这些设备跟传统的CPUs相比有更强的计算能力和更大的内存，因此我们只需要使用很少的几块加速卡就能够实现只有在大规模并行环境下才能计算的任务。 


\section{预处理技术}
\label{related:precond}
在某些应用中，迭代算法可能在给定时间内无法收敛，或者收敛的速度达不到要求，此时就需要进行适当的预处理。
通常情况下，判断预处理方法好坏的标准有三点。第一、预处理之后得到的系统更容易求解，即经过预处理之后，迭代算法能够更快的收敛； 第二、预处理过程的计算开销较小，需要确保使用预处理之后，每一步的迭代开销不至于太大； 第三、预处理子的构造相对简单，即前期处理的计算开销不大。 
通常情况下，这三个条件中需要取得一个平衡。判断预处理子的效果的最终指标是预处理之后系统的求解时间比没有预处理的时候要小很多。 
值得一提的是，第三条中的预处理子前期处理的时间的重要性与预处理子能否被重用有关系。在很多应用中，需要求解一些列有着相同的系数矩阵但是不同的右端项的方程组。
这时，可以用更大的前期处理开销来换取一个更加有效的预处理子，因为前期处理的开销在反复的求结果中被均摊。 
使用隐式方法求解发展方程，比如海洋模式中的正压模态，以及使用牛顿迭代方法求解非线性问题时，通常会遇到这种情况\cite{benzi2002preconditioning}。

正压模态求解器的总时间开销等于求解器达到给定收敛条件所需要的迭代步数乘以每一次迭代的时间开销。
随着计算所使用的处理器核心数的增大，每一步迭代中的计算所消耗的时间是逐渐减少的，
但是通信所需要的时间会逐渐增加。 
当所使用的核心数增加到一定数目时，计算时间上已经足够小，而通信时间逐渐变成主要开销，最终导致总时间随着核数的增加而增加。 
为了减少通信的开销，人们通常采用预处理这一技术来减少收敛所需要的迭代次数。
附加的前提条件是预处理过程的开销在合理的范围之内。 
目前海洋模式POP中采用的默认求解器ChronGear通过使用一个简单的对角预处理方法，性能就已经取得了很好的提升\cite{pini1990simple, reddy2013comparison}。 
如果能够进一步的提高求解器的收敛速度，求解过程中通信的开销将会极大的减少，从而进一步的提高求解器的可扩展性。
事实上，一个有效的预处理子不仅能够给新的求解器带来性能提升，同时也能够改进原有的默认的ChronGear求解器。


共轭梯度法中的预处理方法自从上世纪90年代以来就一直备受重视。 
很多的线性系统在采用了适当的预处理子之后，预处理共轭梯度法只需要少数几步迭代就能够收敛。 
然是，大多数的最有效的预处理技术， 比如说不完全的Cholesky分解和不完全的LU分解，在海洋模式中并不是十分的有效。 
海洋模式中的椭圆方程通常需要在并行的环境中求解，需要为之设计专门的可并行化的预处理子。 



\subsection{传统预处理方法}
\label{related:classical}

传统串行环境中的不完全LU预处理（ILU）在并行环境中很不适用。这是由于ILU方法中的高斯消去过程很难并行。 
而且，ILU的预处理过程中求解上三角和下三角方程只能高度串行执行。
采用区域分解技术，不完全因式分解方法可以实现一定程度的并行。 
Hysom等人\cite{hysom2001scalable}给出了传统ILU预处理方法的并行版本。 
他们的实验表明，这些并行的ILU方法在几百个处理器时仍有较好的可扩展性。

在并行环境中，预处理方法还需要考虑到原始系数矩阵的结构。 
通常情况下，我们希望预处理子尽可能与原始系数矩阵有相同的稀疏结构，这样就能避免额外的复杂通信和存储。 
由于海洋模式POP中的数据是分布在多个进程上的，而进程之间的通信开销很大， 如果使用因式分解的预处理方法，通常只能接受比较浅层次的分解，比如说ILU(0)。 
ILU(0)分解中，L和U分别与原始矩阵A的上三角和下三角矩阵具有相同的非零元结构\cite{benzi2002preconditioning}。
这导致L和U的乘积只是A的一个非常粗糙的近似，从而使得这种预处理的效果并不是很明显。 
更为精确的ILU因式分解方法并不太适用于海洋模式，因为它需要更多的额外的通信和计算。 
同时，计算这些高阶的预处理子的代价也会越高。 

\subsection{误差向量传播方法}
\label{related:evp}


误差向量传播方法（EVP）原本并不是预处理方法，而是作为椭圆方程的直接求解方法。 
相比于LU分解，使用EVP求解椭圆方程离散后的线性方程的计算复杂度要低很多。 
据我们所知，EVP方法的计算复杂度是串行求解椭圆方程的算法中最低的一个。
EVP方法及其变化形式被用在很多个海洋模式中，如Sandia海洋模拟系统\cite{dietrich1987ocean}和加拿大版本的DIEcast模式\cite{tseng2011parallel}。 
同时，Tseng和Chien等人还将改进过的基于区域分解的并行EVP方法作为求解器应用在全球海洋模拟中。

EVP方法的基本思想是通过将边界条件分成两部分，在一部分的边界上给出一组预估值，然后利用方程的定义和这组猜测的值在整个区域上向着第二个边界行进。
如此得到的结果在第二组边界上的值通过与给定的边界条件对比，可以对第一个边界上预估值进行修正。 然后再利用修正之后的值重新行进一次，得到整个区域上的正确结果\cite{roache1995elliptic}。 
EVP方法是行进方法的一种，比较著名的行进方法还有GSM(Generalized Sweep-out Method)\cite{hirota1970direct}，BIR(block-implicit relaxation)\cite{dietrich1975optimized}等。
所有的行进方法都有一个特点，那就是数值不稳定性。离初始边界越远，行进方法的解对初始边界中的扰动就越敏感 \cite{roache1995elliptic}。
EVP的数值不稳定性导致在给定的计算精度下，原始的EVP方法只能在比较小的问题中才能计算出满足要求的解。 
但是通过结合区域分解的思想，行进法仍然可以求解实际应用中的问题。 
本文中，我们既希望利用EVP方法求解的高效性，又希望避免EVP方法的不稳定性，于是我们提出了在海洋模式并行中每一个进程所得分的快上使用EVP求解。 
这样，我们就相当于高效的计算得到原始系数矩阵中主对角子矩阵上的逆。 然后利用这些子矩阵的逆构造成预处理矩阵对原始方程进行预处理。 
后面的章节中，我们将证明这样的方法对海洋模式的性能有很大的提升。 





\subsection{并行预处理方法}
\label{related:parall}

使用最广的串行预处理技术当属不完全的因式分解方法，比如不完全的LU分解（ILU）和它的变种\cite{benzi2002preconditioning}。 
但是，这些方法并不适合在并行的环境中使用，因为它们需要对整个矩阵做一个按顺序的逐次的计算。 
随着并行计算的兴起，一些可以并行化的预处理技术，比如说多项式预处理、近似逆预处理、多重网格预处理和块预处理，逐渐引起了人们的重视。 
高阶的多项式预处理能够像不完全的LU分解（ILU）以及它的变种在串行的环境中一样高效的减少迭代算法的迭代次数\cite{benzi2002preconditioning} 。 
但是多项式预处理子巨大的计算开销抵消了它与在减少迭代次数上的优势，因为一个$k$阶的多项式预处理子在每次一次迭代过程中需要进行$k$次矩阵向量乘操作。 
最终的实际运行中，它的时间开销有时候反而比不上简单的对角预处理\cite{meyer1989numerical,smith1992parallel}。
近似逆预处理，尽管可并行度很高，但是它需要求解一个比原始方程大很多倍的线性方程组\cite{smith1992parallel,bergamaschi2007numerical}， 这就使得它的魅力相比于简单的预处理方法大打折扣。

在1985， Concus等人 \cite{concus1985block} 使用原始矩阵的逆矩阵的条带状近似作为预处理矩阵，在椭圆微分方程问题的求解中取得了比其他预处理子更好的效果。 
Smith等人\cite{smith1992parallel}在海洋模式POP 的最原始版本中采用多项式预处理的方法以及一个局部近似逆预处理的方法，将迭代步数缩短为原来的三分之到五分之一。
但是由于多项式预处理方法中，前期得到多项式预处理子的开销比较大，在后期的版本中这一方法并没有得到继承。  
Adamidis等人 \cite{adamidis2011high} 在Max Planck研究中心的全球海洋海冰模式MPIOM中采用了一个不完全的Cholesky预处理子，在提高预处理共轭梯度法的性能的同时，也改善了它的可扩展性。 
Watanabe等人\cite{Watanabe2006pcg} 设计了一个基于重叠的区域分解法的预处理共轭梯度法来加速收敛，同时减少了进程之间的通信开销。 
 
多重网格是一种针对椭圆微分系统中的线性方程组的高可扩展和十分高效的预处理方法。 
最近的研究表明几何多重网格（GMG）在使用规则网格和简单地形的大气模式
 \cite{muller2014massively}和海洋模式中\cite{matsumura2008non,kanarska2007algorithm}中有很好的效果。 
但是，全球海洋模式通常使用比较复杂的地形(如群岛、海峡、通道和复杂的海岸等)，并结合以非规则或者各向异性的网格， 结果导致简单的几何多重网格并不能取得较好的效果
\cite{matsumura2008non,fulton1986multigrid,tseng2003ghost,stuben2001review}。 
在公共地球系统模式CESM的海洋模式分量POP中，为了避开极点奇异性问题，采用的是极点偏移的广义正交网格。 
海洋模式POP将陆地点掩盖掉，从而只计算地球表面的海洋部分。
这些选择导致了模式中的椭圆方程所得到的系数是定义在一个不规则的网格上的不规则区域， 进而导致几何多重网格很难取得好的效果。 
地形的复杂性在高分辨率的海洋网格中会变得更加糟糕，因为成千上万的群岛和海峡通道（比如白令海峡)在稍微粗一点的网格上并不可见。
对于这些涉及复杂的地形的问题，代数多重网格通常比几何多重网格更加的实用。 
但是代数多重网格也有一个缺陷，那就是在某些例子里面，代数多重网格的启动开销比它的迭代求解过程还要耗时，
这使得它反而不如一些预处理得比较好的共轭梯度法
\cite{muller2014massively}， 尤其是在使用共轭梯度法所需要的迭代步数比较少的时候。 
地球系统模式CESM中的海洋模式分量POP中的正压模态求解问题就是这样一个例子（参见下一节的图
 \ref{fig:iter}）。
更进一步，不管是高分辨率还是低分辨率，海洋模式POP的每一个模拟天内都需要对正压模态中的线性方程求解几十次甚至上百次，
而通常的一次模拟中往往需要模拟成百上千个模拟年，这就导致代数多重网格方法的启动开销变得无法接受。


最后，块预处理技术被证明是一个比较有效的并行预处理技术\cite{concus1985block, white2011block}。
这个技术对于海洋模式POP尤为有潜力，因为它能够充分地利用POP中由椭圆方程离散化后得到的矩阵的块状结构的性质。
在并行时，每个进程上的块采用第\ref{related:evp}节介绍的EVP方法来进行预处理，就得到了并行的块预处理方法。
第\ref{cha:precond}章，我们采用的就是这种并行策略。

\section{气候模式的正确性验证}
\label{related:verify}

目前，使用计算机可执行程序来表示一个模拟模型的需求正在不断增加。 
虽然有很多的软件测试的方法，但是，由于气候模式的不确定性，模式的验证要比气候模式的软件验证要艰难得多。
正是这种困难，使得整个数值气候模拟社区中，都缺乏对于数值模拟模式正确性验证的重要性的理解和意识\cite{whitner1989guidelines}。 
气候模式的发展过程需要不断进行如下的验证：保证代码质量的软件测试，保证气候模式模拟结果的气候态与观测和理论结果相符的模拟评估与验证，以及介于前面两者之间的一致性检验\cite{whitner1989guidelines,wittenberg2014enso,baker2015,oreskes1994verification}。
这三个方面往往由于相互渗透而难以区分。下面我们首先介绍一下软件测试和模式评估与确认，然后介绍本文所关心的一致性检验。

\subsection{气候模式的软件测试}
\label{related:softVerify}
气候模式作为一种计算机程序，在开发的过程中首先要保证的是代码质量。
这个软件工程领域中，有很多的软件验证能够用来对数值模拟程序进行验证\cite{whitner1989guidelines}。
不论是模式的开发初期，还是在模式更新迭代的过程中，都需要针对新的改动进行软件测试。
软件测试是模式能够正常运行并且模拟结果可被接受的基础\cite{oreskes1994verification,clune2011,easterbrook2011}。


与其他计算机软件的测试一样，气候模式的软件测试也可以在不同层次上进行。 
粗粒度的软件测试是通过对整个模式（如耦合气候模式CESM）或者模式中的某些相对独立的分量（海洋模式中的正压模态等）进行测试，从而检测模式中是否存在软件缺陷。
这种测试可以发现软件的整体质量，但是无法区分缺陷的来源。
同时，由于气候模式往往都是并行的，粗粒度的测试往往需要消耗更多的计算资源\cite{clune2011}。
细粒度的软件测试，则是针对软件的独立的部件，比如气候模式中全局通信操作的函数，进行测试。
这种测试能够有效的找到软件缺陷的位置，并且为改善软件质量提供具体指导。



\subsection{气候模式的评估与验证}
\label{related:climateValidation}

气候模式是为了模拟和预测现实中的气候变化而开发的软件，因此，即使模式在软件上没有缺陷，也不能保证模式是正确的。 
评判模式好坏的最重要的标准是考察模式的模拟结果是否与真实的观测结果相一致。
由于气候模式不管如何发展，都只是气候系统的一个近似，它的评估与确认往往十分困难\cite{martis2006validation}。
并且，气候系统本身的不确定性更增添了气候模式评估与确认的难度。 

在制定未来气候变化缓解和适应的对应策略时，必须要考虑到未来气候变化的不确定范围。
气候预测本质上有五个维度：三维空间，时间和概率。 
由于气候本身具有很大的不确定性，主流的气候模式，目前基本上都牺牲掉概率分辨率，而对其它四个分辨率不断地做优化。
没有考虑概率维度的气候模式的模拟结果存在很大不确定性，要想对气候模式进行正确性验证也是十分困难\cite{whitner1989guidelines}。


要想实现对气候模式的正确性验证，必须考虑到气候模式的概率这一维度， 即考虑到气候模式的不确定性。 
迄今为止，已经有一些研究利用初始条件中的不确定性，以及改变边界条件所带来的影响等方法来研究气候模式的不确定性。
但是对于大部分的变量，几十年的气候模拟中主要的不确定性并不在初始条件或者外部驱动，而在于气候系统的响应。
这个问题在大气海洋环流模式（AOGCMs）中已经得到了解决，主要是通过采用非直接指定的观测数据的集合模式的比较，来减少对可能性集合的限制\cite{allen2002towards} 。 
这要求有几十年的集合模拟的结果来评估气候自身的混动性和模式响应的不确定性。 
有研究基于近代气候变化的观测，对模式响应作出了统计学估计，认为气候的敏感性，也就是全球平均温度对于大气中二氧化碳浓度增加一倍的平衡响应，要大于5K\cite{stainforth2005uncertainty}。
他们通过利用常规的环流模式来进行几千次模拟而得到的集合模拟，发现这些版本跟其他的前沿的模式的模拟结果一样真实，但是气候的敏感性从2K到11K不等。
这个几段范围的敏感性对于气候系统对于大气中温室气体的升高的响应的研究，以及评估将特定目标稳定在某个层次所带来的风险是非常有意义的。



另外，可以通过参数化的方式来对模式中的不确定性进行量化。
Reynolds等人\cite{reynolds1994random}通过对误差的来源的研究，给出了美国国家气象中心的中范围预测模型的随机增长误差的三维结构，进而为研究其不确定提供了定量手段。
他们认为气候模式中的随机误差的增长分为两类： 一类是外部误差增长，主要是由于模式的缺陷导致的；一类是内部误差增长，主要是由于初始条件中的误差的自增长 。 
通过对预测和验证分析的相关性的参数化，可以确定内外部增长的速率。
这种参数化假设线性的随机增长主要是由于模式的缺陷引起的。 
他们的结果表明，在热带地区，结合模型和分析的结果，可以显著的改善模拟结果。
而在中纬度地区，模式的改进很难改善预测的结果，所以减少分析的误差变得尤为重要。 
参数化能够得到物理上有意义，并且和之前的预测结果相一致的结果。
他们的这种方法为评估预测不确定性在空间和时间上的分布提供量化手段。


\subsection{气候模式的一致性检验}
\label{related:ECT}

在模式的发展过程中，有很多改动往往很难使用前面所述的软件测试和模式评估与确认的方法来检测，比如提高数值算法的性能，改进参数化方案，移植到新的架构上，以及增加并行度等。
模式引入这些改动后得到的新的模拟结果很难做到与原始结果做到二进制一致，因此简单的软件测试无法证明改动是否合理。
但是从气候学的角度，这些改动不应该引起不一致的气候结果。因此，采用气候模式评估与确认的方式很难找出改动前后的差别\cite{yong2015}。


目前CESM的海洋分量模式POP中可用的正确性测试工具是基于均方根误差的正确性检验，它是一个比较简单的评估海洋模式POP程序移植到了一个新的机器上时，是否存在硬件或软件层的缺陷\cite{vertenstein2011cesm1}。 
测试使用特定设置的实验在新的机器上运行五个模拟天，然后计算其输出结果和美国国家大气研究中所提供的标准的数据集中的海表高度场的均方根误差。 
基于均方根误差的正确性检验方法对于评估CESM在新的机器上的输出结果是很方便的，但是它无法评判CESM-POP中最新的线性求解中的改动所产生的微小的气候状态的改变\cite{yong2015}。
而且，基于均方根误差的正确性检验方法的评判需要专家来检查所得到的均方根误差曲线，具有很强的主观性。

大气模式的正确性验证也会遇到类似的困难。
2014年，Allison等人\cite{baker2014methodology}为了验证公共地球系统模式CESM的公共大气模式（CAM）中的数据被压缩之后是否仍然有效，提出了利用集合模拟的结果 来作为评估无法做到二进制一致的改动的基准。
之后，他们又将他们的验证压缩是否有效的工作进行推广，发展成为CESM集合模拟一致性检测工具（CESM-ECT）\cite{baker2015}。
这个检测工具通过一个新的基于集合模拟的方法解决了检测气候模式输出结果的难题。 
这个工具能够评判一个新的气候模拟结果与以原始结果为基础构造的被认为是可以接受的集合模拟的结果在统计学意义上是否是一致的。 
但是这个CESM-ECT工具只评估了CESM中大气分量模式--公共大气模式（CAM）的变量，并且其试验并不是完全耦合的CESM配置。
直接将CAM-ECT方法应用于海洋数据并不可行，因为海洋和大气在动力学、空间尺度和时间尺度上的差别都很大。
比如， 海洋模式中气候尺度比大气中的气候尺度要小一到两个量级，海洋，尤其是深海中运动的时间尺度比大气中的要慢很多个量级。
因此，本文第\ref{cha:verify}章将进一步探讨如何在海洋模式中实现一致性检测。 


\section{本章小结}
\label{related:Conclude}

随着气候模拟的需求日益增加、观测资料和计算资源等辅助条件的日益成熟，气候模式不断地提高模拟精度已经成为一个大的趋势。
很多高性能计算领域的研究都在关注如何使得科学应用能够适应大规模的并行环境。 
在将地球系统模式移植到大规模并行环境上的过程中，海洋模式中的正压模态的差的可扩展性逐渐的暴露出来。 
海洋模式POP中，斜压模态的计算量占整个模式的绝大部分，但通信相对较少、可扩展性较好，其计算时间随着计算规模的增大而减少。
目前有很多研究工作指出海洋模式POP的正压模态是它的可扩展性的瓶颈。

已有的很多研究表明，正压模态中的全局归约操作的开销和所使用的进程数的多少成正相关的，所以通信开销随着进程数的增加会逐渐变得不可接受。
有很多研究工作尝试去提高正压模态的性能，减少共轭梯度法中的全局通信的负面影响。
一些方法尝试减少共轭梯度法的全局通信的开销，以及将计算与通信相重叠。 
另一些方案在海洋模式中尝试使用陆地点移除和负载均衡的方法来减少进程数，进而减少其相应的全局归约操作的开销。 

预处理技术在实际应用中应用十分广泛。为了进一步提高海洋模式中正压模态的求解性能，很多研究工作都尝试通过预处理技术来加速正压模态的求解。 
传统的因式分解方法（如ILU等），虽然可以实现一定程度的并行，在大规模并行环境中仍然有很多限制。
近年来发展的并行预处理技术解决了可扩展性问题，但是有些预处理效果不佳，有些启动开销太大。 
并行块预处理是比较适合并行海洋模式的一种方法，它充分的利用海洋模式并行划分的特点，在预处理效果和预处理开销上实现了很好的平衡。

由于模式的不确定性，模式中的任何改变都可能得到二进制不一致的结果。
简单的软件测试并不能判断改动是否合理。
同时，包括算法改进在内的很多改动，理论上并不足以改变气候模式模拟的气候状态，传统的气候模式验证方法同样无法判断这类改动是否应该被气候模式所接受。
这就需要我们提供一种评判某种改变是否会对模式的结果造成统计学上显著的改变的工具。
模式自身的不确定性使得这种评判十分困难。尽管如此，已有一些利用集合模拟的方法来对模式不确定性进行量化。
利用这些量化的结果，模式的结果有了很大的改进。 

 


