\chapter{基于集合模拟的海洋模式一致性检测}
\label{cha:verify}

\section{本章概述}
\label{verify:intro}

公共地球系统模式CESM是一个应用广泛的全耦合气候模拟程序\cite{hurrell2013community}， 它的模拟结果经常被提交到政府间气候变化委员会的评估报告中\cite{stocker2013ipcc}。
CESM由多个分量模式耦合而成，其中包括大气、海洋、海冰和陆地等的分量模式。 
本文专注于CESM的海洋分量模式并行海洋模式POP。  
POP求解的是一个采用静力平衡近似和Boussinesq近似的海洋动力学三维原始方程,它描述的海洋模式过程在时间和空间上的尺度都很大。  

CESM中的海洋分量模式并行海洋模式 (CESM-POP)被广泛的应用于气候研究。 
目前有很多关注如何提高CESM-POP性能的工作，比如提高数值算法的性能，改进参数化方案，移植到新的架构上，以及增加并行度等。 
由于海洋模式动力过程混沌的特性，即使对代码做一些细微的改动，也无法保证修改后的模式得到的结果与原始结果是二进制一致的。 
而且，判断模式中的改动是不是可以被接受的（也就说是不是在统计的意义上与原始结果一致）并非易事。 
最近的一个工作显示，对大气模式的数据利用基于集合模拟的统计方法取得了很好的效果。
这个基于集合模拟的统计学一致性检测工具的核心是利用集合模拟结果的可变性的量化结果来作为评判未来模拟的标准，并且利用统计学上的区分度来做判断。 

由于海洋模式和大气模式在动力学和时间尺度上有着明显的区别，
本章采用了一种结合集合模拟的平均状态和方差的统计学方法来对海洋模式的模拟结果进行检测。 
具体来说，新的检测方法利用CESM-POP集合模拟的结果的统计学分布来计算新的模式结果在每一个点上的标准分。 
标准分大于某一个给定值在所有点中所占的比例，可以反映出新的模式结果与集合模拟结果的统计学差别。 
这里，集合模拟成员的个数和成员的挑选都很重要。
实验表明，新的海洋模式POP的集合一致性检测工具（POP-ECT）能够区分那些统计学上明显与集合模拟的结果一致的模拟结果和那些明显不一致的模拟结果。 
同时，这个检测工具提供了一个简单、客观和系统的方法，来检测CESM-POP是否有硬件或者软件层引入的错误。
这个工具进一步提升了CESM-POP代码的质量保证。 

\section{气候模式的正确性检测}
\label{verify:Backgroud}

最近CESM-POP中的很多进展都是关心如何减少计算开销\cite{yong2015}， 但是数值模拟程序的中的任何开发都需要软件质量保证，来确保不会在程序中引入错误。 
这种维护科学程序的可信性的质量保证，对于气候模式来说尤为重要。 
因为气候模式的模拟结果经常影响到关系国计民生的政策方针的制定\cite{carson2002, easterbrook2011}。 

  
气候模式，比如CESM，通常都代码量大并且程序复杂。 
模式中过多的配置选项使得很难使用穷尽列举的方式测试它们 \cite{clune2011, pipitone2012}。 
另外，由于气候模式本身的混沌性，判断一个新的模拟结果与原始结果之间的差别是由某个错误引起的还是由于模式本身的不确定性引起是一件非常具有挑战的事情。 
在模式的初始条件或者中间结果中引入浮点数精度级别的随机扰动都会使得最后的结果产生比较大的偏差。
CESM-POP中的一些新的成果，尤其是那些提高性能的成果（比如利用新的异构加速技术和改进数值方法等），通常都会导致新的模式的输出结果与原来的结果不是二进制一致的。 
对于CESM-POP来说，即使是在同一个超级计算机上采用不同的处理器核数来计算，得到的结果都不会是二进制一致的。 
如果可以直接评估CESM-POP的海洋数据的气候学上一致性，将会极大的促进模式的的发展，同时使得模式能够更加灵活的应用新的软件或者硬件技术。 

本节将介绍两种气候模式正确性检测方法，并且利用求解器的引入的误差作为检测标准，来看其中这两个方法是否有效。
由于海洋动力过程本身具有混沌性，即使在正压求解中引入一个浮点数舍入误差精度级别的扰动，也可能使得最终的模式结果与原始结果截然不同。 
既然不能保证引入新的求解器之后所得到的结果与原始结果是二进制一致的，
那么在将新的P-CSI求解器和EVP预处理正式的加入到海洋模式POP的版本中之前，需要证明加入它们之后不会影响模拟结果的正确性，更不能改变所得到的气候的状态。
这正是本文设计一致性检测工具的初衷。 


\subsection{海洋模式的均方根误差检测}
\label{verify:premethod}
 

目前海洋模式POP中可用的正确性测试工具（称之为POP-RMSE），是一个比较简单的评估CESM-POP程序是否成功的移植到了一个新的机器上的检测。 
这个工具的主要目标是发现新机器上硬件或软件层的问题。 
这个工具的测试中，首先将特定设置的实验在新的机器上运行五个模拟天，然后将其输出结果和美国国家大气研究中所提供的标准的数据集相比较。
这里需要计算两个结果的海表高度场的均方根误差（RMSE）。 
比如对于两个包含$\aleph$个值的数据集合$X_0$ 和$X_1$，它们的均方根误差可以表示为
 \begin{equation*}
 RMSE(X_0, X_1) = \sqrt{\frac{1}{\aleph}\sum_{i=1}^\aleph(X_1(i)-X_0(i))^2}.
 \end{equation*}
然后，利用得到的均方根误差的增长曲线与给定的两个样例所得到的曲线相比较。 
这两个样例中，一个是原始的配置，另一个是在求解器中采用比默认收敛条件要高一个量级的收敛条件。 


\begin{figure}%[!t]
\begin{center}
\includegraphics[height=7cm]{temp_rmse}
\end{center}
\caption[] {采用不同收敛条件的1度海洋模式POP模拟结果与使用最严格收敛条件得到的结果的温度场的每个月的均方根误差（RMSE）。}
\label{fig:ssh_rmse_t}
\end{figure}

POP-RMSE对于评估CESM在新的机器上的输出结果是很方便的， 但是它比为大气模拟数据设计的CAM-ECT的表达能力要弱得多。 
比如说，POP-RMSE无法评判CESM-POP中最新的线性求解中的改动所带的微小的气候状态的改变\cite{yong2015}。 
第\ref{cha:precond}节将默认的预处理共轭梯度法求解器替换成预处理的Chebyshev迭代算法，以此来提高CESM-POP的计算性能。
尽管新的P-CSI求解器在高分辨率模式中的通信开销比原始的预处理共轭梯度法的要小很多，但是在将这个新的求解器应用在海洋模式中之前，必须证明它不会对海洋的模拟结果造成负面的影响。 
因此，为了验证POP-RMSE是否能够检测出求解器在不同时间所引入的误差，我们搜集了1度分辨率的CESM-POP在不同的收敛条件（$10^{-10}$ 到$10^{-16}$）下36个月的运行结果。
图\ref{fig:ssh_rmse_t} 给出的是最紧的收敛条件的实例 ($10^{-16}$) 和其他收敛条件的实例的结果的温度场之间的均方根误差。 
尽管这些例子采用不同的收敛条件，图\ref{fig:ssh_rmse_t} 中很难体现出来这些由于求解器误差所带来的影响\cite{yong2015}。 



当海洋模式POP移植到新的机器上时，也会遇到类似的问题，即不同的机器上得到的模拟结果不是二进制一致的。 
目前海洋模式POP中提供了一个比较简单的评估地球系统模式CESM在新的机器上的运行结果（这些结果可能是有软件环境或者硬件环境引入的错误的）的方法， 但是给定的1度的POP实验表明它并不能检测和评估求解器引入的误差。 
这些实验中，正压求解器的收敛条件分别为$10^{-10}$ 到$10^{-16}$之间的值（默认为 $10^{-13}$）。这些实例的模拟结果被用来计算与使用最严的收敛条件（$10^{-16}$）的模拟结果均方根误差。 

图 \ref{fig:ssh_rmse_t} 中给出了采用不同的收敛条件得到的模拟结果中的温度场的每个月的均方根误差。 
值得一提的是，为了凸显线性求解器的影响，实验结果只考虑公海区域网格点上的值（POP在几个边缘海内的模拟并不算好）。 
可以很明显的看出，改变求解器的收敛条件所引入的误差并没有在最后的温度场中得到体现（也没有在速度和海表高度等诊断场中的得到明显的体现）。 
收敛条件越松，求解器中引入的误差就会越大。
因此，使用最松的两个收敛条件的（$10^{-10}$和$10^{-11}$）的实例的运行结果所计算出来的均方根误差理论上应该比其他实例的要大一些。 
但是，从图\ref{fig:ssh_rmse_t} 中可以看出， 
在第12个月到第20月之间，收敛条件为$10^{-10}$的例子的均方根误差在所有实例中是最小的。 
这与理论推测不符，表明POP-RMSE并不能检测出求解器所引入的误差。

\subsection{基于集合模拟的一致性检测}
\label{verify:enseble}

最近由Allison等人\cite{baker2015}研发的CESM集合模拟一致性检测工具（CESM-ECT），通过一个新的基于集合模拟的工具解决了检测气候模式输出结果的难题。 
这个工具能够评判一个新的气候模拟结果（比如引入了软件或者硬件的改动）与以原始结果（没有任何改动的版本）为基础构造的被认可的集合模拟的结果在统计学意义上是否是一致的。 
但是他们的CESM-ECT工具只评估了CESM中大气分量模式--公共大气模式（CAM）的变量，并且其实验并不是完全耦合的CESM配置（比如说其中海洋分量并不是采用的并行海洋模式POP，而是海洋气候数据模式。这个模式只能够提供海表温度数据，但是不能响应气候分量模式提供的强迫）。 
为了简洁，本文将为CESM的通用的集合模拟统计一致性测试工具称之为CESM-ECT，将应用于公共大气模式分量的检测方法称之为CAM-ECT。
CAM-ECT是CESM-ECT工具集中的一个模块。 

值得注意的是，直接将CAM-ECT方法应用于海洋数据并不可行，因为海洋和大气在动力学、空间尺度和时间尺度上的差别都很大。
比如说，海洋模式中涡旋的空间尺度要比大气中的小一到两个量级，海洋，尤其是深海中运动的时间尺度比大气中的要慢很多个量级。
因此，本章专门为海洋模式中的一致性检测开发了一个新的方法，并称之为POP-ECT。 
尽管这个新的POP-ECT工具也是利用CESM的集合模拟的结果来评估模式的不确定性，它和CAM-ECT是有本质区别的。 
POP-ECT的统计过程中考虑到了海洋中不确定性的空间分布特点。另外，由于海洋达到全球准稳态所需要的时间比大气需要的时间长得多，因此，在POP-ECT中需要采用与CAM-ECT中不一样诊断时间。 
同时，海洋模式中的可用的诊断变量的个数比较少，促使POP-ECT采用跟大气模式不一样的诊断方案。 

这里首先介绍一下Allison等人提出的针对CAM的一致性检测工具，然后引出它在海洋模式中的移植版本POP-RMSZ，并且重新使用求解器的测试样例来验证这个方法是否有效。

\subsubsection{公共大气模式的一致性检测 }
\label{verify:CAM}
Allison等人\cite{baker2015}提到的CESM-ECT检测工具利用集合模拟的结果来对CESM模式的气候态的内在的不确定性进行量化，进而将新的模拟结果（由于软件、硬件或者其他不能保证二进制一致的改动引入的新的结果）与这个集合模拟结果的分布做对比。
这个想法的关键是，如果新的模拟结果的输出数据与集合模拟的结果在统计学上是不可以区分的话，那么这个新的结果就认为是与原始结果“一致的”。统计学上的一致性是模式代码正确性验证的质量保证方面的关键因素\cite{oberkampf2010}。
CESM-ECT方法首先被应用于公共大气模式CAM分量的历史输出数据，最终形成了CAM-ECT工具集。
CAM数据很直观的就被当成了验证的首要目标，因为大气中扰动传播的时间尺度要比在CESM其他分量中的短很多。而且，CAM包含有很多不相关的全局变量。 


 
正如Allison等人\cite{baker2015}所描述的那样，CAM-ECT中使用的集合模拟结果是在可信的机器上使用CESM的被验证过的版本和配置运行得到的。 
这个集合模拟包含有151个长达一年的模拟结果，这些结果之间唯一的不同是在初始的大气温度场中加入了$\mathcal{O}(10^{-14})$ 量级的扰动。 
集合模拟的输出结果只包含了特定变量在每个点上的年平均值。这些变量的个数记为$N_{var}$，它们可以反映出整个大气场（默认情况下 $N_{var}=120$）。这个CAM-ECT工具集是对集合模拟结果中的每一个变量的全球的面积加权平均用主成分分析（PCA）的方法，生成了一个反应集合模拟特征的统计学分布。
这个主成分（PC）分数的分布被保存下来，之后用来与新的模拟实验作对比。 
基于落在指定置信区间（通常取95$\%$）之外的PC分数的个数，可以确定少数的几个新的实例（通常是3个）是否通过测试。 
这里可以调试与是否能通过测试相关的参数，从而达到想要的误报率。


\subsubsection{海洋模式均方根标准分检测}\label{verify:rmsz}



正是因为现成的简单的均方根误差测试并不能检测出来模拟结果的气候态是否被改变，本章提出了一种新的基于统计的方法POP-RMSZ，并且用这种方法来评估海洋正压求解器的影响。 
这个方法的灵感来源于Allison等人的工作\cite{baker2014methodology}，他们为了验证公共地球系统模式CESM的公共大气模式（CAM）中的数据被压缩之后是否仍然有效，并不是仅仅使用一次模拟的结果，而是利用集合模拟的结果来评估无法做到二进制一致的改动。 
POP-RMSZ方法和Allison所提到的方案很类似\cite{baker2014methodology}。
首先，运行一系列的实例。这些实例除了在初始的海洋温度场中加入了$10^{-14}$量级的随机扰动之外，和默认的配置完全相同。 
这个量级的扰动理论上不会造成模拟结果的气候状态发生变化。 
后面的实验结果表明，40个这个样的实例就足以表现出海洋模式自身的扰动性。
由于海洋模式中需要模拟的海洋运动的时间尺度比大气中的长， 这个集合模拟中的实例也模拟了比Allison等人在大气模式中更长的模拟时间。 
值得一提的是，POP-RMSZ最终决定选择三维的温度场作为评估对象（而不是像现有的评估方式那样选择二维的海表高度），因为温度场是找到不同实例之间差异的最好的诊断变量。 
 
 
POP-RMSZ用如下的流程来判断一个新的结果是否和指定的集合模拟结果具有一致性。 
首先生成了一个包含有40个运行了36个月的模拟的集合，这些实例与原始实例的差别在于在初始的海洋温度场引入了一个$\mathcal{O}(10^{-14})$量级的扰动。 
然后计算新的模拟结果 $\tilde{{X}}$和这个集合模拟的结果用如下的方式计算均方根标准分。 
假设集合$E$所包含的成员的个数记为 $N_{ens}$，此时，对于每一变量$X$，在每一个点$i$，都存在一个包含$N_{ens}$个数的数列。
定义点$i$上的集合模拟结果中对应的数列的所有元素的平均值和标准方差分别为$\mu_i$ 和 $\sigma_i$。 
由于总的网格点数为$\aleph$，那么对于变量$\tilde{{X}}$，新的模拟结果与集合模拟结果$E$之间的均方根标准分定义为
\begin{equation}
 RMSZ(\tilde{X}, E) = \sqrt{\frac{1}{\aleph}\sum_{i=1}^\aleph(\frac{\tilde{x}_i -\mu_i}{\sigma_i})^2}. 
\label{e:rmsz}
\end{equation}


\begin{figure}%[!t]
\begin{center}
\includegraphics[height=7cm]{temp_rmsz}
\end{center}
\caption[] {采用不同收敛条件的1度海洋模式POP模拟结果中的温度场的每个月的均方根标准分（RMSZ）。黄色的区域表示集合模拟中40个实例结果的均方根标准分的分布。 }
\label{fig:ssh_rmsz_t}
\end{figure}

为了验证POP-RMSZ是否有效，本节利用它重新评估一下不同的求解器收敛条件的影响。
图\ref{fig:ssh_rmsz_t} 给出了与图\ref{fig:ssh_rmse_t}中相同的五个收敛条件的模拟结果的均方根标准分数。
这里，由最宽松的收敛条件引入的误差变得非常的明显。  
图\ref{fig:ssh_rmsz_t} 可以看出，与简单的均方根误差不同， 这个新的基于集合模拟的方法能够发现收敛条件越松，结果中的误差就越大。 
现在，使用最松的两个收敛条件的例子得到的均方根标准分数也是最大的，可以明显的与集合模拟的结果区分开来。 

最后，这个基于集合模拟的判断指标还可以用来来评估一下本文所提出的新的P-CSI求解器。 图\ref{fig:ssh_rmsz_t}的结果表明，使用P-CSI求解或者使用最紧的两个收敛条件所得到的结果与集合模拟的结果是相容的。 
因此，新的求解器并没有在模式中引入气候模式意义上不可接受的误差，它在CESM-POP中是可以接受的。  
 
由于海洋中的时间尺度比大气中的要长一些， 直观上讲，CESM-POP中统计学一致性检测工具需要的集合模拟的模拟时间应该会更长一些。 
值得一提的是，图\ref{fig:ssh_rmsz_t} 似乎又有悖于的这个假设。 
可以看出来，当收敛条件足够严格的时候（收敛条件小于$10^{-12}$时）， 均方根标准分在模式运行几个月之后随着时间的推移而逐渐减小。
这表明，我需要进一步的研究一致性检测所需要的模拟时间的长度。 
实际上， 图\ref{fig:ssh_rmsz_t}可以看出，这个给定的1度分辨率的海洋数据是相对确定的，在求解器中引入的误差足够小（也就是收敛条件足够小的时候）初值场中的误差在模拟了一年之后逐渐的耗散掉了。



%----------------------------------------------------------------------------
\section{海洋模式一致性检测工具}\label{verify:ECT}


第\ref{verify:rmsz}节中给出来的求解器验证性工作很有启发性，而且完全满足目前的需求。 
但是它仍然有几个遗留问题没有解决，这促使本文研发了一个类似于CAM-ECT这样的更强大的针对CESM-POP数据的评测工具。 
第一，一个更通用的海洋模式POP的验证性工具首先考虑的是海洋中空间的变化特点，这个特点比大气中的要更加突出。
CAM-ECT和第\ref{verify:rmsz}节中的均方根标准分检测方法是利用空间的平均值的差别来作评估，目前还不清楚这样的策略是否有足够的能力来检测海洋中的正确性表达问题以及模式本身的误差。
第二，由于CESM-POP的相互独立的诊断性变量要比大气模式CAM少很多，因此一致性检测的量化指标需要进一步的探讨。
第三，不同的衡量指标的选择促使本章进一步检查集合模拟的大小应该如何选择。
在均方根标准分检测方法中，四十个实例组成的集合模拟就足以检查出线性求解器中的误差，而这个集合模拟的大小并没有在更通用的环境中进行实验验证。
而且，这个大小要比CAM-ECT中使用的默认大小151要小很多。
最后，由于海洋和大气中的时间尺度不同，集合模拟的模拟时间究竟多长最为合适还有待研究。 
由于海洋中的时间尺度比大气中的要长一些， 直观上讲，CESM-POP中统计学一致性检测工具需要的集合模拟的模拟时间应该会更长一些。 
 
在CESM-ECT工具集中扩充CESM-POP一致性检测的工具（记为POP-ECT），需要一个能够反映海洋模式自身不确定性的恰当的集合模拟结果，并且需要一种针对海洋自身特点的方法。
这里首先讨论一下构造集合模拟的理论依据以及如何构造这个集合模拟结果，然后介绍一下新的测试工具的流程。 


\subsection{初始扰动与强迫扰动}\label{verify:pertub}

由于POP-RMSE方法并不能明显的检测出不同的收敛条件所带来的影响，我们在2015年的超级计算大会发表的文章中采用了一种集合模拟的方法来测试海洋模式POP的输出数据\cite{yong2015}。 
这个工作是基于Allison等人\cite{baker2014methodology}中提出的测试数据压缩的影响的方法（这也是CESM-ECT方法的前身）。
需要注意的是，Allison等人提到的集合模拟是通过对初始值进行扰动得到的。 
但是，改变海洋模式中正压模态线性求解器的收敛性判据或者像我们的文章\cite{yong2015}中所提到的引进新的求解器，都可以近似为强迫场的扰动。 
很有必要先研究一下，仅仅通过初始场的扰动所得到的结果状态集是否能够表示在每一个时间步上对强迫场进行扰动所生成的状态。
这里，仿照Caya等人\cite{caya1998}的做法，海洋模式POP的时间迭代过程可以用如下的简单方程来表示：
\begin{equation}
\frac{\partial X(t)}{\partial t} = \alpha X(t) +G
\label{e:1}
\end{equation}
这里 $G$ 表示一个固定的强迫项，  $\alpha$是一个常数，  $X(t)$是关于时间变量的函数， $X(0) = X_0$。 
方程 (\ref{e:1}) 的解析解为：
\begin{equation}
X(t) = (X_0 +\frac{G}{\alpha})e^{\alpha t } -\frac{G}{\alpha}
\label{e:2}
\end{equation}
这个例子里面，假设$\alpha$是一个纯虚数，这样$X(t)$就是一个震动波（这里不考虑减振机制）。 

 
首先，假设在初值中加入扰动，即
\begin{equation*}
X_0' =X_0+P
\end{equation*}
这里 $P$ 是一个常量。方程 (\ref{e:1}) 在采用扰动后的初始值之后的解析解可以表示为 
\begin{equation}
X_P(t) = (X_0+\frac{G}{\alpha}+P)e^{\alpha t } -\frac{G}{\alpha}
\label{e:Pan}
\end{equation}
也可以表示为
\begin{equation}
X_P(t)-X(t) = Pe^{\alpha t }
\label{e:Perr}
\end{equation}
方程 (\ref{e:Perr}) 表明原始结果和扰动初始条件后得到的结果的差是振荡的。
下面考虑当在强迫场中加入一个扰动，即
\begin{equation*}
G' = G + F
\end{equation*}
这里 $F$ 是一个常量。  方程(\ref{e:1})加入带扰动的强迫项后，其解析解可以表示为
\begin{equation}
X_F(t) = (X_0 +\frac{G}{\alpha})e^{\alpha } -\frac{G+F}{\alpha}
\label{e:Fan}
\end{equation}
也可以等价于
\begin{equation}
X_F(t)-X(t) = \frac{F}{\alpha} 
\label{e:Ferr}
\end{equation}

\begin {figure} 
\centering
\begin{subfigure}[t]{1\textwidth}
\centering
\includegraphics[height =5cm]{pert-force1}
\caption{加入初值场扰动(P)或强迫场扰动(F)后得到的解析解。\label{fig:1Danalytical1}}
\vspace{10pt}
\end{subfigure}
\begin{subfigure}[b]{1\textwidth}
\centering
\includegraphics[height =5cm]{pert-force2}
\caption{加入初值场扰动(P)或强迫场扰动(F)后得到的解与原始解的差。\label{fig:1Danalytical2}}
\vspace{10pt}
\end{subfigure}
\caption{方程(\ref{e:2}) 在给定的初值场扰动(P)和给定的强迫场扰动(F)下对应的解析解，以及这个结果与原始解之间的差别。}
\label{fig:1Danalytical}
\end {figure}

式 (\ref{e:Ferr}) 表明强迫场中加入固定的干扰项后对结果产生的影响也是固定的。
因此，可以用方程(\ref{e:Perr})的初始场中引入扰动所带来的误差的量级来衡量在方程(\ref{e:Ferr})的强迫场中引入扰动所带来的误差。 
举个例子，在图\ref{fig:1Danalytical}中给出一个初始扰动和强迫扰动对方程(\ref{e:2})的最终结果的影响。
在这个例子中，强迫项的扰动所引起的误差比初始条件扰动所引起的误差还小。
图\ref{fig:1Danalytical1}显示的是方程(\ref{e:Pan}) 和 (\ref{e:Fan})所给出的解析解，图\ref{fig:1Danalytical2}显示的方程 (\ref{e:Perr}) 和 (\ref{e:Ferr}) 所给出的是不同的$P$和$F$的值得到的结果的误差。
这个实验中，所有的四个扰动在原始的（也就是没有加入任何扰动）结果上取得的效果是相似的。 
由强迫场上的扰动(F)所导致的误差是固定的，并且比初值场上的扰动(P)带来的误差小一个量级。
可以看出，当初始值扰动的组合足够多时，它们所带来的误差的集合，可以在任何时间覆盖强迫场所带来的误差。 
因此，选择使用基于由扰动海洋模式初始的温度场而得到的集合模拟结果，来评估求解器或者其它模拟过程中所引入的不确定性是合理的。



\subsection{POP数据集合的构造}\label{verify:createEns}

 
POP-ECT通过将CESM-POP的输出数据与很多被认可的海洋状态组成的集合作对比，可以评估输出数据与数据集合在统计学上的差别是否显著。
如果显著，则可以认为这个输出数据与给定的数据集合是不同的气候状态。 
因此，将CESM-ECT应用到CESM-POP数据的第一步就是要构造出一个合适的数据集合。 
很明显，数据集合的组成对于测试的有效性来说至关重要，而且这些数据必须在一个被认可的机器上采用被认可的CESM版本来生成。
这里，与CAM相比，海洋模式的诊断变量要少很多，相互独立的诊断变量有：温度（TEMP），海表高度（SSH），盐度（SALT）， 以及与模式所用网格相对应的经向和纬向速度（分别为UVEL和VVEL）。
这五个变量中，只有海表高度SSH是二维变量，其他都是三维变量。 

 
在POP-ECT中，构造了一个由$N_{ens}$模拟结果组成的数据集合$E$， 记为 $E =\{E_1, E_2, \dots, E_{N_{ens}} \}$。
这些模拟结果与指定的默认版本之间的唯一不同是在初始的海洋温度场中加入$\mathcal{O}(10^{-14})$量级的随机扰动。 
第\ref{verify:pertub}节已经通过一个简单的分析，形象给出了这种集合的合理性。
这个初值扰动的大小和双精度浮点数的舍入误差在一个量级，因此它理论上不会造成气候上的改变。
这个数据集合的成员的数量必须足够的多，才能够生成一个比较有表达力的分布。
但是同时，这个数量又要足够的小，因为增加一个成员就等于增加一份计算开销。 
稍后，第\ref{verify:ens}节将讨论数据集合的大小的选择。
这里的讨论和之后的实验都采用 $N_{ens} \;=\; 40$这个配置。
实验表明，如果只是用来做一致性测试，这个大小的集合足以充分的反应海洋的内在的不确定性。
模拟数据集合包含有在每个点上五个POP诊断变量（TEMP, SSH, SALT, UVEL和VVEL）的$T$个月份的月平均数据。
每一个这样的变量$X$都包含有$\aleph$个网格点，记为${X} = \{ x_1, x_2, \dots, x_{\aleph}\}$， 这里$x_i$ 表示在网格点$i$上变量$X$的月平均值。
 
CESM-ECT方法的下一步是量化数据集合的分布特征，进而为新的模拟结果提供评估依据。
这个数据集合的统计特征描述被存在一个数据集合汇总文件，并且这个文件会被贴上生成这些模拟结果的CESM自带的软件标签。
当这个汇总文件一旦生成， 数据集合中$N_{ens}$个模拟结果的历史文件就不需要继续存储了。
生成大气模式CAM一致性检测的汇总文件时，会计算每个变量在每个点上的可用的年平均数据的全球面积加权平均值。
这些计算结果就构成了每个变量的$N_{ens}$个全球平均。 
然而，这个方法采用的全面积加权平均不能很好的应用在海洋模式数据中，因为海洋模式的不确定性相比于大气模式数据来说，在不同位置的网格点上差别更大一些。也就是说，在海洋的不同的区域上，扰动所造成的误差的量级差别很大。
因此，新的检测工具需要更多的考虑到空间上的分布特征。 

\begin {figure} 
\centering
\includegraphics[height =20cm]{gimp_all_sst_std.png}
\caption{第1, 12, 24和36个月份上，海表温度在数据集合上的标准方差。}
\label{fig:SST_STD_all}
\end {figure}

比如，考虑一个由$N_{ens} \;=\; 40$个使用1度分辨的海洋模式POP作为海洋模式分量的CESM模拟$T\;=\;36$个月得到的模拟结果组成的数据集合。 
图 \ref{fig:SST_STD_all}中给出的是数据集合的1,12,24和36个模拟月份中海表温度（SST）的标准方差的空间分布。
注意到这里海表温度SST仅仅只是三维变量TEMP的最上面一层（更加准确的说，是10米的海洋表层）。
图 \ref{fig:SST_STD_all}可以看出来，标准方差远远不是空间均值分布的，不同的网格点之间的值相差好几个数量级（注意颜色刻度尺的刻度）。 
从1月份到12月份的变化也十分明显，这主要是与模式冷启动时由于流体动力学不稳定性造成的模式不稳定有关系。  
在模拟一年之后，在热带区域出现的标准差最大，这表明集合模拟中热带不稳定波的增长带来了更大的不确定性\cite{legeckis1977}。
由于赤道区域的网格分辨率更细一些（$1/3$度左右），这些大的可变性在 赤道地区很容易被强化。 
在几个主要的海洋环流系统区域内，也有几个比较大的标准方差集中区域。
从12个月到36的变化相对较小，这表明相应的物理不稳定性由于海洋的耗散将不会继续增长。
鉴于图 \ref{fig:SST_STD_all}中明显的不确定性，第\ref{verify:rmsz}节中的均方根标准分策略可能在某些不确定性很小的区域由于方程(\ref{e:rmsz})中的分母太小引入的潜在误差。
这里值得强调的是，图\ref{fig:SST_STD_all} 中的不确定性的大小是与分辨率有关的，
并且，图\ref{fig:SST_STD_all} 中的结果只适应于有耗散的低分辨率海洋模式，比如说目前大部分气候研究中所使用的1度的CESM-POP。

 
综上所述，为了构造出一个在CESM-POP数据上比较健壮的集合统计学一致性检测工具，必须得到一个既包含有空间信息，又包含有时间信息的数据集合。
特别的，POP-ECT构造的集合综述文件中第$T$ 个 月份的时间片CESM-POP数据包含有：
\begin{itemize}
 \item $N_{var} \times \aleph \times T$ 个数据集合在每个点上的月平均值 ($\mu$)
 \item $N_{var} \times \aleph \times T$ 个数据集合在每个点上标准方差($\sigma$)
 \end{itemize}
 这也就是说，数据集合保存了指定个月份$T \;=\; 36$ 在所有$\aleph$ 个点上的集合平均值和标准方差值（这里 $\aleph$ 与变量是二维还是三维的有关系）。
 

最后值得一提的是，由于在CESM-POP中，淡水和盐度之间没有适当的淡水反馈机制，在没有任何特殊改动的情况，CESM-POP在封闭的内海区域（比如哈德逊湾和地中海）可能会产生一些与实际不符的盐度分布。
当前版本的CESM-POP在非耦合的模拟中加入了一个很强的淡水恢复机制，而在耦合模拟中加入了一个边缘海淡水平衡机制。
这些特殊的处理能够保持盐度的平衡，但是对于模式的动力过程造成了虚假的强迫。
因此，本文的工作不去讨论如何在边缘海中正确的做验证，而是将重心限制在开放海域内。

\subsection{验证过程}
\label{verify:ECTprocess}
 
利用前面所得到的POP-ECT综述文件，可以通过以下的方法来判断一个新的模拟输出结果（比如说改动了代码，或者移植到了新的机器上，或者采用了一个新的编译器选项等)是否和指定的数据集合的分布所描述的海洋气候状态在统计学上是一致。 
由于只有五个比较基础的诊断变量，因此不需要采用主成分分析的方法。 
POP-ECT采用的策略是在每一个给定点上评估新的模拟结果和数据集合之间的标准差。
对于每一个给定点$i$和某一个给定的变量$\tilde{{X}}$， 在给定的时间片$t$上采用标准分方法计算$\tilde{{X}}$和数据集合的距离。 
特别的，给定变量$\tilde{{X}}$ 在 $t$时刻的值，$\tilde{{X}} = \{ \tilde{x}_{1,t}, \tilde{x}_{2,t}, \dots, \tilde{x}_{\aleph,t}\}$， 那么在给定点$i$ 处变量$\tilde{{X}}$ 在$t$时间的标准分为
\begin{equation*}
Z_{\tilde{x}_{i,t}}=  \frac{\tilde{x}_{i,t} -\mu_{i,t}}{\sigma_{i,t}},
\end{equation*}
这里 $\mu_{i,t}$和$\sigma_{i,t}$分别表示指定的数据集合在点 $i$处，变量$\tilde{{X}}$在给定的$t$月份的几何平均和标准方差。  

 
下面，为了简洁，对于某一个时间片$t$，在相关的变量中去掉时间变量下标。比如说，标准分记为$Z_{\tilde{x_i}}$。 
在每一个点上给定一个标准分阈值$tol_{Z}$，也就是说如果 $Z_{\tilde{x_i}} > tol_{Z}$就表明$i$这个点是一个“不通过”的点。 
由于标准分表示的是一个数与平均值之间的标准方差，所以标准分越大就表明这个新的模拟结果和数据集合所描述的气候状态越远。 
下一步将考察一下所有点中通过标准分标准的点所占的比例。 定义给定变量$\tilde{X}$的标准分通过率（ZPR）为：
\begin{equation}\label{e:zpr}
ZPR_{\tilde{X}} = \frac{ \#\{i \;|\; \tilde{x_i} \in \tilde{X} \; \land \; |Z_{\tilde{x_i}}| \; \leq \; tol_{Z}\} }{\#\{i \;|\; \tilde{x_i} \in \tilde{X} \} }.
\end{equation}
 
为了给出一个评判给定变量$\tilde{X}$ 是否通过测试的整体性标准，POP-ECT对标准分通过率设置了一个最小阈值($min_{ZPR}$)。 
也就是说，如果$ZPR_{\tilde{X}} \geq min_{ZPR}$成立，则认为 $\tilde{X}$通过测试。
默认情况下，标准分的通过阈值为$tol_{Z} \; = \; 3.0$， 而标准分通过率ZPR的阈值为$min_{ZPR} \; = \; 0.9$。 
换句话说，新的模拟结果中变量$\tilde{X}$要想通过测试，必须保证这个变量在90$\%$以上的点上的值落在在对应点对应变量的集合平均值($\mu$) 的$3.0$个标准差之间。
POP-ECT对五个独立的诊断变量依次做上面的判断。 
只有当所有的变量都通过测试，才认为这个新的模拟结果整体上来说和数据集合在统计意义上是一致的。


 
注意到计算得到的标准分随着模拟时间的改变而改变。 
由于海洋运动的时间尺度比较长，本章中大部分的实验都将CESM运行36个月。
另外，模拟过程中的月输出的时间片数据（CAM-ECT中只保存了年平均数据）都被保存下来，用来考察数据集合中的海洋状态能否随着时间的延长而稳定下来。 



在后面的章节中可以看到，标准分通过率通常在几个月的模拟之后便会平稳下来，而且这种平稳的趋势在几个诊断变量中都是相似的。 
因此，除了挑选出合适的标准分的阈值以及标准分通过率的阈值，POP-ECT还选择了一个时间点（$t_C$）
来判断新的运行结果（而不是去检查每个月的数据）。 
这种情况下，集合模拟的时间长度不需要比$t_C$更长。 

\subsection{软件工具}
\label{verify:ECTsoft}

为了使得用户和开发者都能够使用新的针对POP设计的诊断方法，POP-ECT已经被添加到现成的CESM-ECT Python工具集中（pyCECT v2.0）。
CESM-ECT Python工具集 (pyCECT v2.0)可以从与美国国家大气研究中心的CESM独立的开源git仓库得到。 (\url{https://github.com/NCAR/PyCECT/releases}). 
这个工具集已经被集成到当前CESM发布的版本中（试验中用的 CESM 1.2.2版本可以参见\url{http://www.cesm.ucar.edu/models/cesm1.2}）。
这个CESM-ECT Python工具集包括了生成CESM特定模块的集合模拟综述文件的工具，以及利用这些集合模拟综述文件来进行统计学一致性检测的工具pyCECT。

由于POP-ECT的综述文件和CAM-ECT的综述文件完全不同，需要利用并行的Python代码pyEnsSumPop来生成POP-ECT综述文件。
具体来讲，从CESM-POP集合模拟的输出文件中，pyEnsSumPop并行的生成一个包含有第\ref{verify:createEns}节中描述的海洋模式一些统计量的集合综述文件。 
CESM软件工程组将会按照需要生成一个新的POP模拟数据的集合，这个数据集合包含有一个注明了具体改动的软件标签。
POP-ECT所生成的集合综述文件和CESM的版本标签将被放到未来发展的模式中。 
有了POP-ECT的综述文件，用户或者开发者就可以利用pyCECT Python工具来评估新的模拟数据的一致性。目前可以选择POP-ECT或者CAM-ECT来对结果进行评估。
新的CESM-POP模拟数据可能来自一个新的机器的移植， 一个新的编译器选项的使用，代码的更新，或者输出数据的改变。
pyCECT评估新的海洋模式模拟结果是否与给定的POP-ECT生成的数据集合是统计意义上一致的，并且从总体上给出一个“通过”或者“不通过”的判断。
另外，在指定的检查时间点$t_C$，pyCECT还会给出每一个变量的标准分通过率。 

% %-----------------------------------------------------------------------------
% % -----------------------------------------------------------------------------
% %----------------------------------------------------------------------------
\section{结果与分析} \label{verify:exp}

 
这一节的主要目标是通过一系列的实验来评估新的一致性检测工具在CESM-POP的模拟数据上的效果。
这些实验都是有预判结果的，比如说重新考察一下改变正压求解器的收敛条件所带来的效果。
这些实验都是用的CESM 1.2.2版本来运行，使用CESM-POP作为活跃的海洋模式分量，CICE作为活跃的海冰分量，而大气和路面模式都采用数据来驱动。
因此，不会出现逐年响应的事件（比如厄尔尼诺南方涛动），而且赤道太平洋地区的变化可能会受到人为的抑制。
这个特殊的分量模式的配置在CESM的官方文档中被记为“G\_NORMAL\_YEA”分量设置。
CESM的网格分辨率采用“T62\_g16”，对应的海洋和海冰模式分量采用是1度($320 \times 384$)分辨率，垂直方向上有60层，以格林兰岛为偏移极点的偏移网格。 
这些模拟都是在美国国家大气研究中心的Yellowstone超级计算机上使用$96$ 个处理器核心（除非特殊说明了处理器核心的数目）运行得到的。 

这些模拟实验不单单是对某一个时间片做了评估，而是对36个月的数据都进行了评估，以此来观察标准分通过率随着时间的变化规律，同时也为$t_C$的选择提供参考依据。
为了从标准分通过率的角度来刻画标准分和模拟时间的关系，并且为$tol_{Z}$和$min_{ZPR}$的选择提供参考依据，实验结果采用了反应曲面法（RSM）\cite{box2007}的方法来展示。 
变量$\tilde{X}$的反应曲面的图表中，给出了不同的模拟月份中，满足一系列的标准分阈值条件$Z_{\tilde{x_i}} > tol_{Z}$的点的比例的关于给定阈值$tol_{Z}$的累积分布函数。
最后，如前面提到的那样，40个模拟结果组成集合模拟对于当前的实验来说已经足够。
但是本文还是在第 \ref{verify:ens}节进一步的探讨了集合成员的个数的选择。  

尽管我们也分析了其他变量，但是为了简洁，这里只展示了温度（TEMP）和海表高度（SSH）的结果。 
这两个变量在海洋模式系统有很强的代表性。海表高度和海洋海流动力系统密切相关，而温度代表着模型的标量（温度、盐度等）的传输。
 

\subsection{正压求解器收敛性条件}
\label{verify:ECT:baroSolver}

 
首先，我们利用新的加强版本的POP-ECT工具来重新评估一下改变正压求解器收敛性条件所带来的影响。
CESM-POP中正压求解器默认的收敛条件是$10^{-13}$， 这里运行一些采用 $10^{-9}$ 到 $10^{-16}$之间的值作为收敛条件的实例，然后输出所有点上的36个月平均数据。
理论上，采用比默认的收敛条件$10^{-13}$更加严格的条件得到的模拟结果应该是与原结果在气候学上是一致的，但是更松一些的收敛条件将会引入一些误差。


\begin {figure} 
\centering
\includegraphics[height =12cm]{RSM-TEMP-tol.png}
\caption {温度（TEMP）的标准分对于时间和标准分阈值的反应曲面。 每个子图代表着采用不同的正压求解器的收敛条件（在子图上有标明）。纵轴上的颜色条表示标准分小于给定的标准分阈值的点所占的比例。}
\label{fig:RSM-TEMP-tol}
\end {figure}
 
\begin {figure} 
\centering
\includegraphics[height =12cm]{RSM-SSH-tol.png}
\caption {海表高度（SSH）的标准分对于时间和标准分阈值的反应曲面。 每个子图代表着采用不同的正压求解器的收敛条件（在子图上有标明）。纵轴上的颜色条表示标准分小于给定的标准分阈值的点所占的比例。}
\label{fig:RSM-SSH-tol}
\end {figure}

图 \ref{fig:RSM-TEMP-tol}和图\ref{fig:RSM-SSH-tol}分别给出了温度和海表高度的反应曲面。 
每张图包含有四个反应曲面：上面两个分别是采用原始默认收敛条件($10^{-13}$)和更严格的收敛条件得到的结果，下面两个是更松的收敛条件（$10^{-10}$和$5.0*10^{-9}$）得到的结果。 
每一个反应曲面中，横轴表示模拟的月份（从1月到36个月），纵轴表示衡量标准分分布的阈值$tol_{Z}$。这里阈值就是计算方程中标准分通过率所用的划定标准分满足某个条件时所用到的阈值。
颜色刻度中标准分通过率采用的是以10\%为间隔的百分比。 
反应曲面对于评估$tol_{Z}$和$min_{ZPR}$的不同组合非常有效。
比如说，考虑变化求解器收敛条件对温度变量的影响。 
图中左上角的\ref{fig:RSM-TEMP-tol}子图显示，原始的收敛条件($10^{-13}$)下，在所有模拟月份中90\% 的点的标准分都小于2.0。
与之相对的，下面的采用为$10^{-10}$收敛条件的子图表明，在第九个模拟月份之后，90\% 的点的标准分小于3.0， 而在第二十四个月，只有百分之七十到八十左右的网格点的标准分要小于2.0。
右下角的子图采用的收敛条件进一步放松 到$5.0*10^{-9}$，它的比较低的标准分通过率表明这个例子中引入较大的误差。
图\ref{fig:RSM-SSH-tol} 中考察了关于海表高度的反应曲面，四个子图分别表示与图\ref{fig:RSM-TEMP-tol}中相同的四个收敛条件，可以看到总体趋势与温度的反应曲面很相似。 
对于采用$10^{-13}$为收敛条件的模拟结果中，在除了第六个月的所有模拟月份中， 90\%的点上标准分都要小于2.0。 
与温度变量的反应曲面类似， 收敛条件为$10^{-10}$ 对应的子图可以出来有明显的误差，这个误差在收敛条件为$5.0*10^{-9}$对应的例子中更加明显。 
温度和海表高度的反应曲面中有一个明显的不同就是，温度得到的曲线随着时间的变化更加光滑。 这主要是由于温度的计算中有一个很重要的扩散过程。

 

\begin{figure} 
\centering 
\includegraphics[height=7cm]{prz_tol_combined.png}
\caption { 
  在正压模态求解器中采用不同收敛条件得到的模拟结果中，对应变量的标准分超过3.0的点所占的比例。左右两张图分别表示温度和海表高度这两个变量对应的结果。}
\label {fig:PRZ-tol}
\end{figure}

如果在图\ref{fig:RSM-TEMP-tol}和图\ref{fig:RSM-SSH-tol}中固定标准分的衡量阈值，就可以很容易的评估ZPR。 
假设采用一个比较保守的选择$tol_{Z} \; = \; 3.0$。 
图\ref{fig:PRZ-tol}给出了温度和海表高度两个变量中，标准分超出阈值 $tol_{Z} \; = \; 3.0$ 的点的百分比。 
如果选择ZPR的阈值为$min_{ZPR} \; = \; 0.9$， 也就对应着图\ref{fig:PRZ-tol}中10\%的不通过率，可以很明显的看出收敛条件为$10^{-10}$的例子就处于定义通过与不通过的边界线上（因此，这个收敛条件值在实际模拟中不能使用）。 
而采用比$10^{-10}$更严格的收敛条件得到的结果的不通过率更低一些，因此，看起来它们的两个变量跟原始结果所得到的变量在统计学上时一致的。
图\ref{fig:PRZ-tol}中的图标很明晰的证明了，随着收敛条件的放松，超出给定标准分阈值的点会增多。 
这个结果比第\ref{verify:rmsz}节中均方根标准分检测的结果更加清楚。 



\subsection{进程数}\label{verify:proc}

 
CESM模拟中，当采用相同的配置，仅仅改变CESM-POP运行的核数时，都会产生不二进制一致的的结果，但是这些模拟结果都应该代表着相同的气候状态（也就说他们在统计学上是不可区分的）。
所以可以确信，这样的模拟结果肯定能通过CESM-ECT的测试。 
这里再次申明一下，CESM-ECT集合模拟中的成员都是在96个处理器核心上运行得到的。
实验另外分别在48,192和384核上进行了同样的模拟，并且都没有使用CESM-POP中的线程并行。 


\begin{figure}
\centering
\includegraphics[height=7.0cm]{temp_cores_zoom_combine.png}
\caption{
在采用不同的处理器核心数得到的模拟结果中，温度变量的标准分超过3.0的点所占的比例。左右两张图分别表示温度和海表高度这两个变量对应的结果。这里左右两张子图表示相同的信息，只是纵轴上的刻度不同}
\label {fig:combine}
\end{figure}
 
图\ref{fig:RSM-TEMP-param}和图 \ref{fig:RSM-SSH-param} 中上面两个子图分别对应的是96核（标记为“original”）和384核上运行结果中温度和海表高度得到的反应曲面图。 
这些图显示，这两种核数的配置下， 对于几乎所有的月份，90\%以上的点的标准分都要比2.0要小。 
正如所料，对于这两个变量，这两种不同的核数的配置得到的结果的差别是微乎其微的。
像之前的做法一样，将标准分的阈值固定到$tol_{Z} \; = \; 3.0$时，就可以得到 图 \ref{fig:combine}中的温度变量在四个不同的核数配置 (48, 96, 192,和384) 下的结果的标准分的不通过率。
如图所示，这四个核数的配置在所有的时间片的不通过百分比都很低（低于1.2\%），这也确认了本章之前的结论，即改变CESM-POP的运行核数对结果造成的影响在统计学意义上并不是显著的，并且这一特征被新的POP-ECT给准确的判断出来。 
由于海表高度对应的图反应出来的结果跟这张图很相似，所以本文就不重复给出了。

 \subsection{物理参数}\label{verify:pp}

\begin {figure}[!ht]
\centering
\includegraphics[height =12cm]{RSM-TEMP-param.png}
\caption {
温度变量的标准分对于模拟时间（单位为月份）和标准分阈值的反应曲面。
上面两张图给出的是采用不同的处理器核心数所得到的结果。
左下方的图表示示踪物混合的对流不稳定性系数采用比默认配置大10倍的值所得到的结果。右下角的实验中采用了与默认配置不一样的示踪物平流方案。
纵轴上的颜色条表示标准分小于给定的标准分阈值的点所占的比例。}
\label{fig:RSM-TEMP-param}
\end {figure}
 
接下来考察了一下预计能够对海洋气候造成改变的例子，即改变示踪物的两个物理参数 ：一个是垂直混合中对流不稳定系数，另一个是示踪物的平流方案的系数。
这样改变物理参数的改动应该是不能通过CESM-ECT的测试。
对于第一个物理参数，在默认情况下，1度的CESM-POP的示踪物混合系数的配置中将对流不稳定的垂直混合系数(\textit{convect\_diff})设为\textit{convect\_diff} $=\; 10,000$。
将这个参数分别放大2,5,和10倍，以期增大海洋内部在密度分层不稳定的时候垂直混合的强度。
这应该对对CESM-POP的结果造成很大的影响，因为对应的混合特性上的改变。
第二个，将POP中示踪物的平流方案(\textit{t\_advect\_ctype}) 的默认配置三阶迎风格式(\textit{upwind3})替换成带有一维通量限制的Lax-Wendroff格式 (\textit{lw\_lim})。
这种改变对于模拟结果同样显著，并且能够导致一个完全不同的气候状态，因为相应的扩散和弥散误差变得不同。

\begin{figure} [!ht]
\centering
\includegraphics[height =12cm]{RSM-SSH-param.png}
\caption {
海表高度变量的标准分对于模拟时间（单位为月份）和标准分阈值的反应曲面。
上面两张图给出的是采用不同的处理器核心数所得到的结果。
左下方的图表示示踪物混合的对流不稳定性系数采用比默认配置大10倍的值所得到的结果。右下角的实验中采用了与默认配置不一样的示踪物平流方案。
纵轴上的颜色条表示标准分小于给定的标准分阈值的点所占的比例。}
\label{fig:RSM-SSH-param}
\end {figure}
 
图 \ref{fig:RSM-TEMP-param}和图 \ref{fig:RSM-SSH-param} 的左下方的子图中分别给出了温度和海表高度在将\textit{convect\_diff}增加十倍之后得到的反应曲面。 这种改变对气候状态造成的影响是很明显的，尤其是和右上角的将CESM-POP所运行的核心数改变为384后得到的反应曲面相比。
实际上，图  \ref{fig:RSM-TEMP-param} 中增加\textit{convect\_diff}得到的效果几乎和图\ref{fig:RSM-TEMP-tol}中将求解器的收敛条件放松至$10^{-9}$得到的效果一样强。
改变平流方案同样会得到不同的气候态， 图 \ref{fig:RSM-TEMP-param}和图 \ref{fig:RSM-SSH-param} 的右下图中有明显的表现，可以看出几乎所有的点都没有通过 标准分检测。 


\begin{figure} 
\centering
\includegraphics[height=8cm]{prz_param_combined.png}
\caption{ 
  采用与默认配置不同的示踪物平流方案 (lw\_lim）以及不同的示踪物混合的对流不稳定性系数的模拟结果中，海表高度变量的标准分超过3.0的点所占的比例。}
\label {fig:PRZ-temp-param}
\end{figure}

   
图 \ref{fig:PRZ-temp-param} 中给出了改变平流方案和示踪物垂直混合的对流不稳定性系数所得到的结果中在$tol_{Z} \; = \; 3.0$ 时标准分的不通过率。
如果选择$min_{ZPR} \; = \; 0.9$作为标准分通过率的阈值，也就是对应了允许的最大不通过率为10\%， 将垂直混合系数增大一倍(\textit{convect\_diff}*2)所得到的结果介于通过临界线上。
剩下的例子中，正如所料，温度和海表高度都没有通过测试。 
基于以上的实验，选择$tol_{Z} \; = \; 3.0$作为标准分阈值，$min_{ZPR} \; = \; 0.9$作为标准分通过率阈值，就可以得到理想的评测工具。
这两个配置被当做pyCECT工具的默认配置。 


 \subsection{模拟时间}\label{verify:time}
 
图\ref{fig:PRZ-temp-param}可以看出来，对于温度和海表高度这两个变量， 实验中不通过标准分测试的点所占的百分比在12个模拟月之后变化很小。
这个结论也可以从图 \ref{fig:RSM-TEMP-param}和图 \ref{fig:RSM-SSH-param}中的温度和海表高度的结果中的出来。 
特别的，海表高度对于初始温度场的扰动的响应在12个月份后被稳定下来。 
海表高度会受到由于密度分成所导致的环流的改变所带来的影响。
基于以上结果，在某一个精心挑选的时间点$t_C$上对输出结果做评估是比较合理。 

  
\begin{figure}
\centering
\includegraphics[height =20cm]{zscore_sst_combine_crop.png}
\caption{四个不同的实验在第12个月时，海表温度（SST）对应于给定数据集合的标准分。这四个实验分别采用原始配置，将处理器核心数从96增大到384， 使用更大示踪物的对流不稳定性混合系数，以及使用不同的示踪物平流方案。}
\label {fig:zscore-combine}
\end{figure}

POP-ECT通常选择$t_C \;=\; 12$作为评估的时间点。
也就是说集合模拟只需要运行长度为$t_C$的时间， 这样可以减少为可能的CESM版本生成集合模拟的计算开销。
图 \ref{fig:zscore-combine}中描述的是在$t_C \;=\; 12$时刻，四种不同的模式配置得到的结果中的海表温度相对于数据集合的标准分的二维平面图。
最上面的是原始配置得到的结果。第二幅是改变CESM-POP的处理器核数到384后的结果，它和第一幅的结果相似。
尽管前面两张图中的分布模式并不是完全相同，但是标准分的量级和分布都很相似的。
这表明改变计算所使用的处理器核心数，得到的结果在一定程度上是统计学一致的。
相反的，增大示踪物的对流不稳定性的混合系数到原来的10倍，就会得到与第\ref{verify:pp}节中不同的气候状态。
这个结论在图\ref{fig:zscore-combine}第三幅图中，第12个月个标准分布可以很明显的看出来。 
最后，图中底部的子图可以看出来，使用一个新的平流格式会导致得到的气候状态完全不同。
这也证实了图\ref{fig:RSM-TEMP-param}和图 \ref{fig:RSM-SSH-param}中所展示的明显的改变。 
采用一个新的平流格式会极大的改变数值格式相应的弥散和扩散过程\cite{tseng2008}，同时也会影响到海洋模式中海流的特征和结构\cite{tseng2006}。
另外，使用通量限制的Lax-Wendroff会引入额外的数值混合，进而与温度和盐度的物理混合产生相会作用，导致最终的结果通常会更加的光滑一些。



% %-----------------------------------------------------------------------------
% % -----------------------------------------------------------------------------
% %----------------------------------------------------------------------------
\subsection{数据集合的规模} \label{verify:ens}

\begin{figure} 
\centering
\includegraphics[height =7cm]{ens_size_combined.png}
\caption{ 不同的数据集合的规模下，1000个测试中的不通过率的分布。左右两个图分别对应温度和海表高度两个变量。
对于给定的数据集合的大小，绿色条块表示测试结果中最大和最小的不通过率，红色的方框表示测试结果的平均值。}
\label{fig:temp_ens_80}
\end {figure}
数据集合的规模（也就是模拟成员的个数）必须要足够的大才能够捕捉到海洋模式自身的不确定性，但是从计算效率的角度来说又必须尽可能的小。
这一节将会讨论一下POP-ECT对于数据结合规模的敏感性。
本节通过如下所述的实验手段，来观察误判率与数据集合的规模之间的关系。 
首先，生成总共80个的集合模拟的成员，这些模拟只是在初始的海洋温度场中加入$\mathcal{O}(10^{-14})$量级的随机扰动。 
然后，在这80个成员中，随机的拿出其中的10个作为测试样例。 
其次，从剩下的70个模拟结果中，分别构造出包含有10、20、30、40、50和60个成员的数据集合。 
这里，对于给定的数据集合的大小，从那70个模拟结果中随机的抽取100次给定数目的结果作为数据集合的成员。
这样对于每一个给定的集合大小，就有100个互不相同的数据集合。 
最后，对于每一个数据集合大小，使用POP-ECT在第$t_c = 12$月份对拿出来的10个测试样例分别基于这个集合大小的所有的100数据结合做评估。
这样就得到了每个集合大小的1000个测试结果。
本文利用第一类误差，也就是“假阳性”率来衡量实验的错误率。 
由于测试集和数据集合的成员都是从那80个有着统计学上一致的气候状态的模拟结果集中抽取出来的，标准分不通过率在理想情况下越低越好。 

图 \ref{fig:temp_ens_80}中给出了这些实验在温度和海表高度这两个变量上的结果。 
横轴表示的是数据集合的大小，纵轴表示的标准分的不通过率。对于每一个集合大小，中间的方块表示的是平均值，误差条表示的是一个标准差的不确定性。
正如所料，随着数据集合规模的增大，假阳性率减少，不确定性的范围也相应的缩减。 
但是，一直增加数据集合的规模所带来的效果是不断减少的，数据集合的大小从10增大到20时假阳性率上的改善要比从50增大到60的时候在假阳性率上的改善要大很多。 
所以数据集合的大小可以选择40，因为40在比较低的误判率和比较低的生成数据集合的开销之间是一个比较好的平衡。 
 

\section{本章小结}
\label{verify:Conclusion}

由于CESM-POP海洋模式被广泛的使用，并且对于很多的气候模拟都有非常重要的作用，
保证它的代码的正确性是至关重要的。 
但是，由于海洋动力过程本身的不确定性，模拟结果常常由于处理器核数的改变等微小的因素而导致最后的模拟结果并不能做到完全一致。
因此，对于气候科学家和模式的开发人员来说，能够简单易行的评判模拟结果是否是统计学上一致是极其重要的。

当前海洋模式POP中提供的基于均方根误差的检测方法虽然能够简单的评估POP在新的机器上的运行结果的正确性，
但是实验证明它并不能检测和评估求解器引入的误差，更不能达到通用正确性验证的要求。
大气模式中的基于集合模拟的一致性检测工具给了我们很大启发，本文在POP中实现了一个类似的基于均方根标准分的检测方法。
这个方法能够清晰的区分出求解器所引入的误差，但是想要成为通用的检测工具，仍然有很多关键问题需要解决。 


最终，本文提出并实现了一个新的针对海洋模式的基于集合模拟的结果的一致性检测工具POP-ECT。
本章首先通过一个简单的理论模型，形象的说明了气候模式中，加入初始扰动得到的结果集能够表达在强迫场中加入扰动后得到的模拟结果。
POP-ECT使用的数据集合就是通过在模拟的初始场中加入随机扰动后得到的，它能够客观的检测出CESM-POP中的统计学显著的改动。
本章通过一些列参照实验，确定了集合模拟过程中几个决定性因素，比如模拟时间长度，集合的个数，评判的标准等。
更多的检测实验证明了这个新方法在检测海洋模式状态中的误差时是非常有效的。 
POP-ECT极大地提升了CESM-ECT工具集在确保CESM模拟质量的能力。



